<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!window.netlifyIdentity) return;

  netlifyIdentity.init();

  netlifyIdentity.on("init", async user => {
    if (!user) {
      window.location.href = "/";
      return;
    }

    try {
      const token = user.token.access_token;

      const res = await fetch("/clearance", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!res.ok) {
        document.body.innerHTML =
          "<h2>Unauthorized</h2><p>Please log out and log back in.</p>";
        return;
      }

      const html = await res.text();
      document.open();
      document.write(html);
      document.close();
    } catch (err) {
      document.body.innerHTML =
        "<h2>Error loading clearance guide</h2>";
      console.error(err);
    }
  });

  netlifyIdentity.on("logout", () => {
    window.location.href = "/";
  });
});
</script>
